<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rifa - Gerenciamento</title>
    
    <link rel="icon" type="image/png" href="css/imgs/favicons/favicon-96x96.png" sizes="96x96"/>
    <link rel="icon" type="image/svg+xml" href="css/imgs/favicons/favicon.svg"/>
    <link rel="shortcut icon" href="css/imgs/favicons/favicon.ico"/>
    <link rel="apple-touch-icon" sizes="180x180" href="css/imgs/favicons/apple-touch-icon.png"/>
    <link rel="manifest" href="css/imgs/favicons/site.webmanifest"/>
</head>
<body>
    <h1>Gerenciamento de Rifas</h1>

    <!-- Formulário de Login -->
    <h2>Login</h2>
    <form id="login-form">
        <label for="login-email">Email:</label>
        <input type="text" id="login-email" name="email" required><br><br>

        <label for="login-password">Senha:</label>
        <input type="password" id="login-password" name="password" required><br><br>

        <p>
            E-mail: sergioCutelaria@gmail.com<br>
            Senha: 3fd243d
        </p>

        <button type="submit">Entrar</button>
    </form>

    <!-- Formulário para cadastrar rifa, visível apenas para administradores -->
    <h2>Cadastro de Rifa</h2>
    <form id="rifa-form" style="display: none;">
        <label for="estilo">Estilo da faca:</label>
        <input type="text" id="estilo" name="estilo" required><br><br>

        <label for="tamanho">Tamanho:</label>
        <input type="text" id="tamanho" name="tamanho" required><br><br>

        <label for="material_lamina">Material da lâmina:</label>
        <input type="text" id="material_lamina" name="material_lamina" required><br><br>

        <label for="material_cabo">Material do cabo:</label>
        <input type="text" id="material_cabo" name="material_cabo" required><br><br>

        <label for="material_bainha">Material da bainha:</label>
        <input type="text" id="material_bainha" name="material_bainha" required><br><br>

        <label for="data">Data:</label>
        <input type="date" id="data" name="data" required><br><br>

        <button type="submit">Cadastrar Rifa</button>
    </form>

    <!-- Consulta do perfil -->
    <h2>Perfil</h2>
    <button onclick="fetchProfile()">Ver Perfil</button>
    <div id="profile-details"></div>

    <script>
        let isAdmin = false;

        // Função para realizar o login e armazenar o token JWT
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                const response = await fetch('https://sh-cutelaria.onrender.com/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('jwtToken', data.token);
                    isAdmin = JSON.parse(atob(data.token.split('.')[1])).isAdmin;

                    alert('Login realizado com sucesso!');
                    document.getElementById('login-form').reset();

                    if (isAdmin) {
                        document.getElementById('rifa-form').style.display = 'block';
                    }
                } else {
                    alert('Falha no login. Verifique o email e senha.');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao realizar login.');
            }
        });

        // Função para cadastrar rifa (acessível apenas para administradores)
        document.getElementById('rifa-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!isAdmin) {
                alert('Acesso negado. Apenas administradores podem cadastrar rifas.');
                return;
            }

            const formData = {
                estilo: document.getElementById('estilo').value,
                tamanho: document.getElementById('tamanho').value,
                material_lamina: document.getElementById('material_lamina').value,
                material_cabo: document.getElementById('material_cabo').value,
                material_bainha: document.getElementById('material_bainha').value,
                data: document.getElementById('data').value
            };
            const token = localStorage.getItem('jwtToken');

            try {
                const response = await fetch('https://sh-cutelaria.onrender.com/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                if (response.ok) {
                    alert('Rifa cadastrada com sucesso!');
                    document.getElementById('rifa-form').reset();
                } else {
                    const error = await response.json();
                    alert(error.error || 'Erro ao cadastrar a rifa');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao cadastrar a rifa');
            }
        });

        // Função para buscar os dados do perfil do usuário autenticado
        async function fetchProfile() {
            const token = localStorage.getItem('jwtToken');

            try {
                const response = await fetch('https://sh-cutelaria.onrender.com/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const profile = await response.json();
                    displayProfile(profile.user);
                } else {
                    alert('Erro ao buscar o perfil.');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao buscar o perfil.');
            }
        }

        // Função para exibir os detalhes do perfil do usuário
        function displayProfile(user) {
            const profileDetails = document.getElementById('profile-details');
            profileDetails.innerHTML = `
                <h3>Detalhes do Perfil</h3>
                <p><strong>Nome:</strong> ${user.name}</p>
                <p><strong>Email:</strong> ${user.email}</p>
                <p><strong>Administrador:</strong> ${user.isAdmin ? 'Sim' : 'Não'}</p>
            `;
        }
    </script>
</body>
</html>
